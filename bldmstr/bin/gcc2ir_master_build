#!/bin/ksh 

PATH=/usr/bin:/bin
unset LANG
unset LANGUAGE

# All scripts are run from the same directory as this one.
SCRIPTDIR=$(dirname $0)

# Set common configuration variables
. $SCRIPTDIR/commonconfig

EXTRALANGWS=
LANGWSLIST="$LANGWSLISTDEFAULT"
INSTALLDIR=""
RUNTESTS=1 
SUNINSTALL=
BUILDOPTIONS=
JOBS=2
MAKE="/usr/ccs/bin/make"
CPUS=2
BUILDTYPE=

setup_defaults()
{
    if [ $BUILDTYPE == i386-sparc ]
    then
	LANGWSLIST="$LANGWSLIST /ws/gccfss/cross-compiler/ceres-lang"
    fi
    if [ 0 && $BUILDTYPE == i386-solaris ]
    then
        LANGWSLIST="$LANGWSLIST /net/cicogna/export/ube6/sstrunk/builds.intel-S2/test0/intel-S2/lang /ws/gccfss/source/gccfss-ube-updated"
    fi

    if [ $BUILDTYPE == sparc-linux ]
    then
	MAKE="/opt/dmake/bin/dmake"
	CPUS=`cat /proc/cpuinfo | grep 'ncpus active' | awk '{print $NF}'`
        LANGWSLIST="/ws/gccfss/linux/ceres_linux $LANGWSLIST"
    else
        CPUS=`/usr/sbin/psrinfo | wc -l`
    fi

    if [ "$INSTALLDIR" == "" ]
    then
	INSTALLDIR=$BUILDDIR/install
    fi
    
    if [ "$EXTRALANGWS" != "" ]
    then
	LANGWSLIST="$EXTRALANGWS $LANGWSLIST"
    fi

    ((JOBS=CPUS*2))

    if [ $JOBS -gt 50 ]
    then
	JOBS=50
    fi
}

usage()
{
	cat <<EOF
Usage: $0 [-g <GCC2IR_WS>] [-i <INSTALL_DIR>] [-l <PROJ_LANG_WS>] [-L "<LANG_WS_LIST>"] [-s <EXISTING_SUN_INSTALLATION>] [-p <EXISTING_CROSS_COMPONENTS>] [-t] [-I] -b <build_type> <build_dir>
where
	<GCC2IR_WS>	is a fully populated gcc2ir source workspace.
			Default: $GCC2IRWS
	<INSTALL_DIR>	is the desired installation directory.
			Default: <build_dir>/install
	<LANG_WS_LIST>	is a list of lang workspace, one of which must be
			fully populated.  This option provides full control over
			which lang workspaces are used.
			Default: $LANGWSLIST
	<PROJ_LANG_WS>	is a lang workspace whose contents are to be brought
			over in addition to those in <LANG_WS_LIST>.
			This is usually a developers private workspace.
			A list of workspaces may be used if enclosed in quotes.
			Default: <none>
	<EXISTING_SUN_INSTALLATON> is a pre-existing Sun or gcc2ir installation.
			It is used to obtain the Sun compiler components,
			rather than building them.  If the -s option is used,
			-l and -L are ignored.
        <EXISTING_CROSS_COMPONENTS> is a pre-existing cross-compiler components installation. 
                        It is only used to obtain libraries and other components needed for sparc during cross compilation. 
	<build_dir>	is the directory to be created under which the build
			will be done
        <build_type>    One of the following {sparc-solaris, sparc-opensolaris, sparc-linux, i386-solaris, i386-sparc }
	-t		do not run tests. This option disables testing.
        -I              do not install Sun backend
EOF
	exit 1
}

while getopts b:g:i:Il:L:op:s:v:t optflag
do
    case $optflag in
        b) BUILDTYPE=$OPTARG
            BUILDOPTIONS="-b $BUILDTYPE $BUILDOPTIONS";;
	g) GCC2IRWS=$OPTARG;;
	i) INSTALLDIR=$OPTARG;;
	l) EXTRALANGWS="$OPTARG";;
	L) LANGWSLIST="$OPTARG"
	    ;;
	p) BUILDOPTIONS="-p $OPTARG $BUILDOPTIONS"
	    ;;
	s) SUNINSTALL=$OPTARG
	    ;;
	v) GCC_VERSION="$OPTARG"
	    ;;
	t) RUNTESTS=0
	    BUILDOPTIONS="-t $BUILDOPTIONS"
	    ;;
	I) BUILDOPTIONS="-I $BUILDOPTIONS";;
        *) usage;;
    esac
done

if [ "$BUILDTYPE" == "" ]
then
    usage
fi

shift `expr $OPTIND - 1`

if [ $# -ne 1 ]
then
    usage
fi

BUILDDIR=$1

setup_defaults

cat <<EOF
Build options being used:
	Build directory:	$BUILDDIR
	Install directory:	$INSTALLDIR
	Gcc2ir workspace:	$GCC2IRWS
	Lang workspaces:	$LANGWSLIST
	Existing Sun install:	$SUNINSTALL
	Run tests:		$RUNTESTS

EOF

if [ "" = "$SUNINSTALL" ]
then
    # Build the Sun backend components
    if [ $BUILDTYPE == i386-sparc ]
    then
	$MAKE -f ${SCRIPTDIR}/../data/Makefile.langbuild -j $JOBS JOBS=$JOBS BUILDDIR=$BUILDDIR LANGWSLIST="$LANGWSLIST" GCC_VERSION="$GCC_VERSION" CHIP=i386-sparc all
    else
        $MAKE -f ${SCRIPTDIR}/../data/Makefile.langbuild -j $JOBS JOBS=$JOBS BUILDDIR=$BUILDDIR LANGWSLIST="$LANGWSLIST" GCC_VERSION="$GCC_VERSION" all
    fi

    if [ $? -ne 0 ]
    then
	echo "Build of lang workspace failed."
	exit 1
    fi
    
    SUNINSTALL="$BUILDDIR/langinstall"
fi

# Build and install gcc2ir
$SCRIPTDIR/build_gcc2ir $BUILDOPTIONS "-w $GCC2IRWS" -i $INSTALLDIR/$GCCINSTSUBDIR -s $SUNINSTALL -v $GCC_VERSION  $BUILDDIR

if [ $? -ne 0 ]
then
	echo Build and install failed.
	exit 1
fi

exit 0

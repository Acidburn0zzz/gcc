#!/bin/ksh

# All scripts are run from the same directory as this one.
SCRIPTDIR=$(/bin/dirname $0)

# Set common configuration variables
. $SCRIPTDIR/commonconfig
                                                                                
function usage {
	cat <<EOF
Usage: $0 [-i <INSTALL_DIR>] <build_dir>
where
	<INSTALL_DIR>	is the installation directory containing the compiler
			Default: <build_dir>/install
	<build_dir>	is the directory under which the gcc2ir build was done
EOF
	exit 1
}


while getopts i: optflag
do
        case $optflag in
		i)	INSTALLDIR=$OPTARG
			;;
                *)      usage
                        ;;
        esac
done
         
shift `expr $OPTIND - 1`
if [ $# -ne 1 ]
then
	usage
fi

BUILDDIR=$1

if [ "$INSTALLDIR" = "" ]
then
	INSTALLDIR="$BUILDDIR"
fi

SUNINSTALL="$INSTALLDIR/$SUNINSTSUBDIR/4.0.4/prod"
if [ ! -e "$SUNINSTALL/bin/iropt" ]
then
	echo $SUNINSTALL does not contain the necessary Sun compiler components
	exit 1
fi

mkdir -p $BUILDDIR/test_results

# Run the gcc tests
${SCRIPTDIR}/rungcctest -r $BUILDDIR -s $SUNINSTALL

# Save results of gcc build check tests
${SCRIPTDIR}/gcc_check_failures -a $BUILDDIR/test_results $BUILDDIR/build.gcc2ir > /dev/null

# Run the gcc tests with the 64-bit flags
${SCRIPTDIR}/rungcctest -r $BUILDDIR -s $SUNINSTALL -o "-m64"

# Save results of the 64 bit gcc tests
${SCRIPTDIR}/gcc_check_failures -a $BUILDDIR/test_results $BUILDDIR/build.gcc2ir > /dev/null

# Run the putback tests
/import/dr3/gcc2ir_putbacktest/bin/gcc2ir_putbacktest.new -b $INSTALLDIR/bin -d $BUILDDIR/pbtests > $BUILDDIR/logs/putbacktest.log 2>&1

# Record the results of the putback tests
${SCRIPTDIR}/hydra_failures $BUILDDIR/pbtests > $BUILDDIR/test_results/pbtest.failures 

# See if all putback tests passed (the e-mail should already indicate this.)
FAILURES=$(/bin/wc -l $BUILDDIR/test_results/pbtest.failures)
echo "Number of test failures: $FAILURES"

